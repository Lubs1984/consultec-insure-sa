# Database Schema

**Project:** InsureConsultec — SA Insurance Agent Lifecycle SaaS
**Database:** PostgreSQL 16
**ORM:** Prisma 6
**Version:** 1.0
**Date:** February 2026

---

## 1. Conventions

- All primary keys: `UUID` generated by `gen_random_uuid()`
- All tables include: `id`, `tenant_id`, `created_at`, `updated_at`, `created_by`, `deleted_at` (soft delete)
- `tenant_id` is non-nullable on all tenant-scoped tables
- Timestamps: `TIMESTAMPTZ` (always with timezone — all stored in UTC, displayed in SAST)
- Text vs. VARCHAR: `TEXT` preferred (PostgreSQL stores same way; avoids arbitrary length constraints)
- Enums: PostgreSQL native enums for status fields (documented below as TypeScript enums for clarity)
- Money: `DECIMAL(15,2)` in ZAR
- Percentages: `DECIMAL(5,4)` (e.g., 0.1250 = 12.5%)
- All tables have RLS enabled with `tenant_id`-based policy

---

## 2. Enums

```sql
-- User roles
CREATE TYPE user_role AS ENUM (
  'super_admin', 'fsp_owner', 'key_individual', 'compliance_officer', 'agent', 'assistant'
);

-- FSP categories (FAIS Act)
CREATE TYPE fsp_category AS ENUM ('I', 'II', 'IIA', 'III', 'IV');

-- Agent lifecycle status
CREATE TYPE agent_status AS ENUM (
  'recruiting', 'background_checks', 'training', 're5_pending',
  're5_passed', 'appointing', 'supervised', 'active', 'resigned', 'debarred', 'transferred'
);

-- Lead pipeline status
CREATE TYPE lead_status AS ENUM (
  'new', 'contacted', 'qualified', 'fna_scheduled', 'quoted',
  'proposal_submitted', 'awaiting_decision', 'won', 'lost', 'dormant'
);

-- Lead source
CREATE TYPE lead_source AS ENUM (
  'referral', 'cold_call', 'networking', 'social_media', 'insurer_lead',
  'aggregator', 'walk_in', 'bancassurance', 'website', 'existing_client', 'other'
);

-- Insurance product category
CREATE TYPE product_category AS ENUM (
  'life', 'disability_lump', 'income_protection', 'critical_illness',
  'funeral', 'short_term_personal', 'short_term_commercial',
  'medical_aid', 'gap_cover', 'retrenchment', 'investment', 'key_person'
);

-- Policy status
CREATE TYPE policy_status AS ENUM (
  'draft', 'submitted', 'underwriting', 'active', 'amended',
  'lapsed', 'reinstated', 'cancelled'
);

-- Premium frequency
CREATE TYPE premium_frequency AS ENUM ('monthly', 'quarterly', 'bi_annual', 'annual');

-- Premium collection method
CREATE TYPE collection_method AS ENUM ('debit_order', 'eft', 'stop_order', 'credit_card', 'cash');

-- Quote status
CREATE TYPE quote_status AS ENUM ('draft', 'presented', 'accepted', 'declined', 'expired');

-- ROA status
CREATE TYPE roa_status AS ENUM (
  'draft', 'complete', 'signed_client', 'signed_agent', 'filed'
);

-- FICA CDD status
CREATE TYPE fica_status AS ENUM (
  'pending', 'in_progress', 'verified', 'enhanced_due_diligence', 'failed'
);

-- Client risk rating (FICA)
CREATE TYPE risk_rating AS ENUM ('standard', 'high');

-- Claim type
CREATE TYPE claim_type AS ENUM (
  'death', 'disability', 'retrenchment', 'critical_illness',
  'vehicle', 'property', 'contents', 'funeral', 'liability', 'marine', 'other'
);

-- Claim status
CREATE TYPE claim_status AS ENUM (
  'filed', 'documents_pending', 'under_assessment',
  'approved', 'paid', 'repudiated', 'ombud_escalated', 'ombud_determination'
);

-- Commission type
CREATE TYPE commission_type AS ENUM (
  'initial', 'renewal', 'binder_fee', 'broker_fee', 'override', 'other'
);

-- Document category
CREATE TYPE document_category AS ENUM (
  'roa', 'rpar', 'fica_id', 'fica_poa', 'consent', 'cpd_cert',
  're5_cert', 're1_cert', 'saps_clearance', 'qualification',
  'appointment_letter', 'fsca_licence', 'claim_document', 'policy_schedule',
  'complaint', 'other'
);

-- Ombudsman type
CREATE TYPE ombudsman_type AS ENUM (
  'fais_ombud', 'long_term_insurance_ombud', 'short_term_insurance_ombud', 'cms_complaints'
);

-- Complaint status
CREATE TYPE complaint_status AS ENUM (
  'lodged', 'investigating', 'conciliation', 'resolved', 'determination_issued', 'closed'
);
```

---

## 3. Core Schema

### 3.1 tenants

```sql
CREATE TABLE tenants (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name                  TEXT NOT NULL,
  slug                  TEXT NOT NULL UNIQUE,          -- subdomain identifier
  trading_name          TEXT,
  registration_number   TEXT,                          -- CIPC company number
  vat_number            TEXT,

  -- FSCA Licence
  fsca_licence_number   TEXT,
  fsp_category          fsp_category NOT NULL DEFAULT 'I',
  authorised_products   product_category[] NOT NULL DEFAULT '{}',
  licence_issued_date   DATE,
  licence_expiry_date   DATE,                         -- NULL = no expiry (ongoing)
  fsca_status           TEXT DEFAULT 'active',        -- 'active' | 'suspended' | 'lapsed'

  -- Contact
  physical_address      TEXT,
  postal_address        TEXT,
  phone                 TEXT,
  email                 TEXT NOT NULL,
  website               TEXT,

  -- Branding
  logo_url              TEXT,
  brand_colour          TEXT DEFAULT '#1a56db',

  -- Billing
  stripe_customer_id    TEXT,
  subscription_status   TEXT DEFAULT 'trialing',
  subscription_plan     TEXT DEFAULT 'starter',
  subscription_expires  TIMESTAMPTZ,

  -- Metadata
  onboarding_completed  BOOLEAN NOT NULL DEFAULT false,
  is_active             BOOLEAN NOT NULL DEFAULT true,
  created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  deleted_at            TIMESTAMPTZ
);

CREATE INDEX idx_tenants_slug ON tenants(slug);
```

---

### 3.2 users

```sql
CREATE TABLE users (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id         UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,

  -- Identity
  email             TEXT NOT NULL,
  password_hash     TEXT,                             -- NULL if SSO-only
  first_name        TEXT NOT NULL,
  last_name         TEXT NOT NULL,
  phone             TEXT,
  avatar_url        TEXT,

  -- Role
  role              user_role NOT NULL DEFAULT 'agent',

  -- Status
  is_active         BOOLEAN NOT NULL DEFAULT true,
  email_verified    BOOLEAN NOT NULL DEFAULT false,
  email_verify_token TEXT,
  password_reset_token TEXT,
  password_reset_expires TIMESTAMPTZ,
  last_login_at     TIMESTAMPTZ,

  -- Tenant invite
  invited_by        UUID REFERENCES users(id),
  invited_at        TIMESTAMPTZ,

  created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  deleted_at        TIMESTAMPTZ
);

CREATE UNIQUE INDEX idx_users_email_tenant ON users(tenant_id, email) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_tenant ON users(tenant_id);
```

---

### 3.3 agents

```sql
-- Extends users with insurance-specific agent data
-- Not all users are agents; an agent always references a user

CREATE TABLE agents (
  id                        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id                 UUID NOT NULL REFERENCES tenants(id),
  user_id                   UUID NOT NULL REFERENCES users(id),

  -- Personal
  id_number                 TEXT,                         -- RSA ID number (13 digits)
  date_of_birth             DATE,
  gender                    TEXT,
  physical_address          TEXT,
  postal_address            TEXT,

  -- FAIS Fit & Proper
  nqf_level                 INTEGER,                      -- 4, 5, 6, 7
  qualification_description TEXT,
  qualification_institution TEXT,

  -- RE Exams
  re5_passed                BOOLEAN NOT NULL DEFAULT false,
  re5_pass_date             DATE,
  re5_cert_document_id      UUID,                         -- FK to documents
  re1_required              BOOLEAN NOT NULL DEFAULT false,
  re1_passed                BOOLEAN NOT NULL DEFAULT false,
  re1_pass_date             DATE,
  re1_cert_document_id      UUID,

  -- Background checks
  debarment_check_date      DATE,
  debarment_status          TEXT DEFAULT 'not_checked',  -- 'clear' | 'debarred' | 'not_checked'
  saps_clearance_date       DATE,
  saps_clearance_expiry     DATE,
  saps_document_id          UUID,
  credit_check_date         DATE,
  credit_check_outcome      TEXT,

  -- Appointment
  status                    agent_status NOT NULL DEFAULT 'recruiting',
  appointment_date          DATE,
  appointment_letter_doc_id UUID,
  appointing_fsp_fsca_num   TEXT,
  authorised_products       product_category[] NOT NULL DEFAULT '{}',

  -- Supervision
  supervised_period_months  INTEGER DEFAULT 12,
  supervisor_id             UUID REFERENCES agents(id),
  supervision_end_date      DATE,
  roa_reviews_completed     INTEGER DEFAULT 0,
  supervision_signed_off_by UUID REFERENCES users(id),
  supervision_signed_off_at TIMESTAMPTZ,

  -- CPD tracking
  cpd_target_hours          DECIMAL(5,1) NOT NULL DEFAULT 6.0,
  cpd_year_start            DATE,

  -- Commission structure
  commission_structure_id   UUID,                         -- FK to commission_structures

  -- Debarment
  debarment_initiated_at    TIMESTAMPTZ,
  debarment_reason          TEXT,
  debarment_effective_date  DATE,
  debarment_document_id     UUID,

  created_at                TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at                TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  deleted_at                TIMESTAMPTZ,
  created_by                UUID NOT NULL REFERENCES users(id)
);

CREATE UNIQUE INDEX idx_agents_user ON agents(user_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_agents_tenant ON agents(tenant_id);
CREATE INDEX idx_agents_id_number ON agents(id_number) WHERE id_number IS NOT NULL;
```

---

### 3.4 cpd_activities

```sql
CREATE TABLE cpd_activities (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES tenants(id),
  agent_id        UUID NOT NULL REFERENCES agents(id),

  activity_date   DATE NOT NULL,
  activity_type   TEXT NOT NULL,    -- 'seminar' | 'online_learning' | 'structured_training' | 'industry_event' | 'article'
  provider        TEXT NOT NULL,
  description     TEXT NOT NULL,
  hours           DECIMAL(4,1) NOT NULL,
  cpd_year        INTEGER NOT NULL,  -- e.g. 2025

  certificate_document_id UUID,      -- FK to documents
  verified        BOOLEAN DEFAULT false,
  verified_by     UUID REFERENCES users(id),
  verified_at     TIMESTAMPTZ,

  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by      UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_cpd_agent_year ON cpd_activities(tenant_id, agent_id, cpd_year);
```

---

### 3.5 clients

```sql
CREATE TABLE clients (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id             UUID NOT NULL REFERENCES tenants(id),
  assigned_agent_id     UUID REFERENCES agents(id),

  -- Identity
  id_number             TEXT,                        -- RSA ID (13 digits) or passport
  id_type               TEXT NOT NULL DEFAULT 'rsa_id', -- 'rsa_id' | 'passport' | 'asylum_permit'
  passport_number       TEXT,
  passport_country      TEXT,
  first_name            TEXT NOT NULL,
  last_name             TEXT NOT NULL,
  preferred_name        TEXT,
  date_of_birth         DATE,
  gender                TEXT,
  marital_status        TEXT,
  nationality           TEXT DEFAULT 'ZA',
  home_language         TEXT,

  -- Contact
  mobile_phone          TEXT,
  work_phone            TEXT,
  home_phone            TEXT,
  email                 TEXT,

  -- Address
  physical_address_line1 TEXT,
  physical_address_line2 TEXT,
  physical_city         TEXT,
  physical_province     TEXT,
  physical_postal_code  TEXT,
  postal_address_line1  TEXT,
  postal_address_line2  TEXT,
  postal_city           TEXT,
  postal_province       TEXT,
  postal_postal_code    TEXT,

  -- Employment
  employment_status     TEXT,  -- 'employed' | 'self_employed' | 'unemployed' | 'pensioner' | 'student'
  employer_name         TEXT,
  occupation            TEXT,
  industry              TEXT,
  monthly_gross_income  DECIMAL(15,2),
  monthly_net_income    DECIMAL(15,2),

  -- POPIA Consent
  marketing_consent     BOOLEAN NOT NULL DEFAULT false,
  marketing_consent_at  TIMESTAMPTZ,
  data_processing_consent BOOLEAN NOT NULL DEFAULT false,
  data_processing_consent_at TIMESTAMPTZ,
  consent_version       TEXT,

  -- Risk profile (for investment products)
  risk_profile          TEXT,   -- 'conservative' | 'moderate' | 'aggressive'
  risk_profile_date     DATE,

  -- Source
  lead_id               UUID,                        -- FK to leads (origin lead)
  client_since          DATE,

  -- FICA
  fica_profile_id       UUID,                        -- FK to fica_profiles (1:1)

  -- DHA verification (future integration hook)
  dha_verified          BOOLEAN DEFAULT false,
  dha_verified_at       TIMESTAMPTZ,

  created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  deleted_at            TIMESTAMPTZ,
  created_by            UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_clients_tenant ON clients(tenant_id);
CREATE INDEX idx_clients_id_number ON clients(id_number) WHERE id_number IS NOT NULL;
CREATE INDEX idx_clients_agent ON clients(tenant_id, assigned_agent_id);
-- Text search on name
CREATE INDEX idx_clients_names ON clients USING gin(to_tsvector('english', first_name || ' ' || last_name));
```

---

### 3.6 dependants

```sql
CREATE TABLE dependants (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES tenants(id),
  client_id       UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,

  first_name      TEXT NOT NULL,
  last_name       TEXT NOT NULL,
  id_number       TEXT,
  date_of_birth   DATE,
  gender          TEXT,
  relationship    TEXT NOT NULL,  -- 'spouse' | 'child' | 'parent' | 'sibling' | 'other'
  is_beneficiary  BOOLEAN DEFAULT false,
  is_insured      BOOLEAN DEFAULT false,  -- e.g. on funeral/medical aid

  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by      UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_dependants_client ON dependants(tenant_id, client_id);
```

---

### 3.7 fica_profiles

```sql
CREATE TABLE fica_profiles (
  id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id               UUID NOT NULL REFERENCES tenants(id),
  client_id               UUID NOT NULL REFERENCES clients(id),

  status                  fica_status NOT NULL DEFAULT 'pending',
  risk_rating             risk_rating NOT NULL DEFAULT 'standard',

  -- CDD Documents
  id_document_id          UUID,          -- FK to documents
  id_verified             BOOLEAN DEFAULT false,
  id_verified_at          TIMESTAMPTZ,
  id_verified_by          UUID REFERENCES users(id),

  poa_document_id         UUID,          -- Proof of address
  poa_issued_date         DATE,          -- Must be < 3 months old
  poa_verified            BOOLEAN DEFAULT false,
  poa_verified_at         TIMESTAMPTZ,
  poa_verified_by         UUID REFERENCES users(id),
  poa_refresh_due         DATE,          -- Set to poa_issued_date + 90 days

  -- Enhanced Due Diligence
  is_pep                  BOOLEAN DEFAULT false,   -- Politically Exposed Person
  pep_screening_date      DATE,
  pep_screening_outcome   TEXT,
  edd_notes               TEXT,

  -- goAML
  suspicious_flag         BOOLEAN DEFAULT false,
  goaml_ref               TEXT,
  goaml_reported_at       TIMESTAMPTZ,
  goaml_reported_by       UUID REFERENCES users(id),

  last_review_date        DATE,
  next_review_date        DATE,

  created_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by              UUID NOT NULL REFERENCES users(id)
);

CREATE UNIQUE INDEX idx_fica_client ON fica_profiles(tenant_id, client_id);
```

---

### 3.8 leads

```sql
CREATE TABLE leads (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id             UUID NOT NULL REFERENCES tenants(id),
  assigned_agent_id     UUID REFERENCES agents(id),

  -- Person
  first_name            TEXT NOT NULL,
  last_name             TEXT NOT NULL,
  id_number             TEXT,
  date_of_birth         DATE,
  mobile_phone          TEXT NOT NULL,
  email                 TEXT,

  -- Pipeline
  status                lead_status NOT NULL DEFAULT 'new',
  source                lead_source NOT NULL DEFAULT 'other',
  source_detail         TEXT,            -- e.g. referrer name
  priority              TEXT DEFAULT 'normal',  -- 'low' | 'normal' | 'high'

  -- Employment snapshot at lead capture
  employment_status     TEXT,
  monthly_income        DECIMAL(15,2),

  -- Consent (POPIA)
  marketing_consent     BOOLEAN NOT NULL DEFAULT false,
  marketing_consent_at  TIMESTAMPTZ,
  data_processing_consent BOOLEAN NOT NULL DEFAULT false,
  data_processing_consent_at TIMESTAMPTZ,

  -- Outcome
  converted_to_client_id UUID,          -- Set on 'won' → links to clients.id
  closure_reason        TEXT,            -- On 'lost' status

  -- Timestamps
  first_contacted_at    TIMESTAMPTZ,
  last_activity_at      TIMESTAMPTZ,
  status_changed_at     TIMESTAMPTZ,

  created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  deleted_at            TIMESTAMPTZ,
  created_by            UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_leads_tenant_agent ON leads(tenant_id, assigned_agent_id);
CREATE INDEX idx_leads_status ON leads(tenant_id, status);
```

---

### 3.9 lead_activities

```sql
CREATE TABLE lead_activities (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id   UUID NOT NULL REFERENCES tenants(id),
  lead_id     UUID NOT NULL REFERENCES leads(id) ON DELETE CASCADE,
  agent_id    UUID REFERENCES agents(id),

  type        TEXT NOT NULL,   -- 'call' | 'email' | 'sms' | 'whatsapp' | 'meeting' | 'note'
  direction   TEXT,            -- 'outbound' | 'inbound'
  subject     TEXT,
  body        TEXT,
  outcome     TEXT,
  duration_seconds INTEGER,

  occurred_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_at  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by  UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_lead_activities_lead ON lead_activities(tenant_id, lead_id);
```

---

### 3.10 needs_analyses

```sql
CREATE TABLE needs_analyses (
  id                        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id                 UUID NOT NULL REFERENCES tenants(id),
  client_id                 UUID NOT NULL REFERENCES clients(id),
  agent_id                  UUID NOT NULL REFERENCES agents(id),
  version                   INTEGER NOT NULL DEFAULT 1,

  -- Financial Position
  monthly_gross_income      DECIMAL(15,2),
  monthly_net_income        DECIMAL(15,2),
  total_assets              DECIMAL(15,2),
  total_liabilities         DECIMAL(15,2),
  monthly_expenses          DECIMAL(15,2),
  outstanding_debt          DECIMAL(15,2),

  -- Objectives
  insurance_objectives      TEXT[],    -- ['death_cover', 'disability', 'savings', etc.]
  special_needs             TEXT,

  -- Risk tolerance
  risk_tolerance            TEXT,      -- 'low' | 'medium' | 'high'
  investment_horizon_years  INTEGER,

  -- Health (for life/disability)
  health_status             TEXT,      -- 'excellent' | 'good' | 'fair' | 'poor'
  smoker                    BOOLEAN,
  chronic_conditions        TEXT[],
  hazardous_occupation      BOOLEAN DEFAULT false,

  -- Existing cover audit (external policies)
  existing_life_cover       DECIMAL(15,2),
  existing_disability_cover DECIMAL(15,2),
  existing_income_protection DECIMAL(15,2),
  existing_short_term_cover TEXT,      -- Brief description
  existing_medical_aid      TEXT,
  existing_funeral_cover    DECIMAL(15,2),

  -- Gap analysis results (computed)
  life_cover_gap            DECIMAL(15,2),
  disability_gap            DECIMAL(15,2),
  income_protection_gap     DECIMAL(15,2),
  funeral_gap               DECIMAL(15,2),
  gap_analysis_notes        TEXT,

  -- Output
  fna_pdf_document_id       UUID,      -- Generated FNA report PDF
  completed_at              TIMESTAMPTZ,
  reviewed_by               UUID REFERENCES users(id),

  created_at                TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at                TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by                UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_fna_client ON needs_analyses(tenant_id, client_id);
```

---

### 3.11 quotes

```sql
CREATE TABLE quotes (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id         UUID NOT NULL REFERENCES tenants(id),
  client_id         UUID NOT NULL REFERENCES clients(id),
  agent_id          UUID NOT NULL REFERENCES agents(id),
  fna_id            UUID REFERENCES needs_analyses(id),

  -- Insurer & Product
  insurer_name      TEXT NOT NULL,
  product_category  product_category NOT NULL,
  product_name      TEXT NOT NULL,
  product_code      TEXT,                    -- Insurer's product code

  -- Quote details
  status            quote_status NOT NULL DEFAULT 'draft',
  premium           DECIMAL(15,2) NOT NULL,
  premium_frequency premium_frequency NOT NULL DEFAULT 'monthly',
  sum_insured       DECIMAL(15,2),
  benefit_amount    DECIMAL(15,2),
  commission_rate   DECIMAL(5,4),            -- e.g. 0.1250 = 12.5%
  commission_amount DECIMAL(15,2),

  -- Terms
  commencement_date DATE,
  term_years        INTEGER,
  waiting_period_days INTEGER,
  exclusions        TEXT,
  loadings          TEXT,                    -- Underwriting loadings
  special_conditions TEXT,

  -- Communication
  quote_reference   TEXT,                    -- Insurer's quote reference
  quote_date        DATE NOT NULL DEFAULT CURRENT_DATE,
  expiry_date       DATE,
  presented_at      TIMESTAMPTZ,
  client_decision_at TIMESTAMPTZ,
  closure_reason    TEXT,

  -- Source
  via_aggregator    BOOLEAN DEFAULT false,
  aggregator_name   TEXT,

  created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  deleted_at        TIMESTAMPTZ,
  created_by        UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_quotes_client ON quotes(tenant_id, client_id);
CREATE INDEX idx_quotes_agent ON quotes(tenant_id, agent_id);
```

---

### 3.12 policies

```sql
CREATE TABLE policies (
  id                        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id                 UUID NOT NULL REFERENCES tenants(id),
  client_id                 UUID NOT NULL REFERENCES clients(id),
  agent_id                  UUID NOT NULL REFERENCES agents(id),
  quote_id                  UUID REFERENCES quotes(id),

  -- Identification
  policy_number             TEXT NOT NULL,
  insurer_name              TEXT NOT NULL,
  insurer_code              TEXT,
  product_category          product_category NOT NULL,
  product_name              TEXT NOT NULL,
  product_code              TEXT,

  -- Status
  status                    policy_status NOT NULL DEFAULT 'draft',
  status_changed_at         TIMESTAMPTZ,
  status_change_reason      TEXT,

  -- Dates
  commencement_date         DATE,
  renewal_date              DATE,
  maturity_date             DATE,           -- For endowments, term policies
  cancellation_date         DATE,
  cancellation_reason       TEXT,

  -- Financial
  premium                   DECIMAL(15,2) NOT NULL,
  premium_frequency         premium_frequency NOT NULL DEFAULT 'monthly',
  premium_collection_date   INTEGER,        -- Day of month (1-31)
  collection_method         collection_method NOT NULL DEFAULT 'debit_order',
  sum_insured               DECIMAL(15,2),
  benefit_amount            DECIMAL(15,2),

  -- Banking for debit order
  bank_name                 TEXT,
  bank_account_number       TEXT,
  bank_account_type         TEXT,
  bank_branch_code          TEXT,

  -- Policy terms
  term_years                INTEGER,
  waiting_period_days       INTEGER,
  exclusions                TEXT,
  loadings                  TEXT,
  special_conditions        TEXT,

  -- Cooling off
  cooling_off_expires       DATE,           -- commencement_date + 30 days
  cooling_off_invoked       BOOLEAN DEFAULT false,
  cooling_off_invoked_at    TIMESTAMPTZ,

  -- Premium collection tracking
  last_successful_collection DATE,
  last_collection_attempt   DATE,
  debit_order_failure_count INTEGER DEFAULT 0,
  grace_period_ends         DATE,

  -- Compliance links
  roa_id                    UUID,           -- FK to records_of_advice
  needs_analysis_id         UUID REFERENCES needs_analyses(id),

  -- Clawback tracking (life products)
  clawback_watch_active     BOOLEAN DEFAULT false,
  clawback_watch_expires    DATE,           -- commencement_date + 2 years (for life)

  -- Replacement flag
  is_replacement_policy     BOOLEAN DEFAULT false,
  replaced_policy_id        UUID REFERENCES policies(id),  -- Policy this replaces
  rpar_id                   UUID,           -- FK to replacement_advice_records

  -- Policy document
  policy_schedule_doc_id    UUID,           -- FK to documents

  created_at                TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at                TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  deleted_at                TIMESTAMPTZ,
  created_by                UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_policies_tenant ON policies(tenant_id);
CREATE INDEX idx_policies_client ON policies(tenant_id, client_id);
CREATE INDEX idx_policies_agent ON policies(tenant_id, agent_id);
CREATE INDEX idx_policies_status ON policies(tenant_id, status);
CREATE INDEX idx_policies_renewal ON policies(tenant_id, renewal_date) WHERE status = 'active';
CREATE INDEX idx_policies_clawback ON policies(tenant_id, clawback_watch_expires) WHERE clawback_watch_active = true;
CREATE UNIQUE INDEX idx_policies_number ON policies(tenant_id, policy_number) WHERE deleted_at IS NULL;
```

---

### 3.13 beneficiaries

```sql
CREATE TABLE beneficiaries (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES tenants(id),
  policy_id       UUID NOT NULL REFERENCES policies(id) ON DELETE CASCADE,
  client_id       UUID REFERENCES clients(id),     -- If beneficiary is also a client
  dependant_id    UUID REFERENCES dependants(id),  -- If beneficiary is a dependant

  first_name      TEXT NOT NULL,
  last_name       TEXT NOT NULL,
  id_number       TEXT,
  date_of_birth   DATE,
  relationship    TEXT NOT NULL,
  allocation_pct  DECIMAL(5,2) NOT NULL,           -- Must sum to 100 across policy

  is_minor        BOOLEAN DEFAULT false,
  trustee_name    TEXT,                             -- Required if minor

  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by      UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_beneficiaries_policy ON beneficiaries(tenant_id, policy_id);
```

---

### 3.14 policy_endorsements

```sql
CREATE TABLE policy_endorsements (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id           UUID NOT NULL REFERENCES tenants(id),
  policy_id           UUID NOT NULL REFERENCES policies(id),
  agent_id            UUID NOT NULL REFERENCES agents(id),

  endorsement_type    TEXT NOT NULL,
  -- 'sum_assured_change' | 'beneficiary_change' | 'address_change' | 'banking_change'
  -- 'premium_change' | 'rider_add' | 'rider_remove' | 'occupation_change' | 'other'

  description         TEXT NOT NULL,
  effective_date      DATE NOT NULL,

  old_value           JSONB,                 -- Snapshot before change
  new_value           JSONB,                 -- Snapshot after change

  submitted_to_insurer_at TIMESTAMPTZ,
  insurer_reference   TEXT,
  confirmed_at        TIMESTAMPTZ,

  requires_roa        BOOLEAN DEFAULT false, -- If advice was given on this change
  roa_id              UUID,                  -- FK to records_of_advice

  document_id         UUID,                  -- Supporting document

  created_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by          UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_endorsements_policy ON policy_endorsements(tenant_id, policy_id);
```

---

### 3.15 records_of_advice (ROA)

```sql
CREATE TABLE records_of_advice (
  id                          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id                   UUID NOT NULL REFERENCES tenants(id),
  client_id                   UUID NOT NULL REFERENCES clients(id),
  agent_id                    UUID NOT NULL REFERENCES agents(id),
  policy_id                   UUID REFERENCES policies(id),
  fna_id                      UUID REFERENCES needs_analyses(id),

  status                      roa_status NOT NULL DEFAULT 'draft',

  -- FAIS Mandated Fields
  financial_position_summary  TEXT NOT NULL,        -- Client's financial info collected
  products_considered         JSONB NOT NULL,       -- Array of {insurer, product, reason_rejected?}
  product_recommended         TEXT NOT NULL,        -- Name of recommended product
  recommendation_rationale    TEXT NOT NULL,        -- Why this product
  alternatives_rejected_reason TEXT,

  -- Disclosures (FAIS mandatory)
  commission_disclosed        BOOLEAN NOT NULL DEFAULT false,
  commission_type             TEXT,
  commission_percentage       DECIMAL(5,4),
  commission_rand_amount      DECIMAL(15,2),
  conflict_of_interest        TEXT,
  conflict_disclosed          BOOLEAN NOT NULL DEFAULT false,
  risk_warnings               TEXT,

  -- Replacement
  is_replacement              BOOLEAN NOT NULL DEFAULT false,
  rpar_id                     UUID,                 -- FK to replacement_advice_records

  -- Signatures
  client_signed               BOOLEAN NOT NULL DEFAULT false,
  client_signed_at            TIMESTAMPTZ,
  client_signature_method     TEXT,                 -- 'wet' | 'docusign' | 'signow' | 'in_app'
  client_docusign_envelope_id TEXT,
  agent_signed                BOOLEAN NOT NULL DEFAULT false,
  agent_signed_at             TIMESTAMPTZ,

  -- Document output
  roa_pdf_document_id         UUID,                 -- Generated ROA PDF

  -- Retention (FAIS 5-year)
  filed_at                    TIMESTAMPTZ,
  retain_until                TIMESTAMPTZ,          -- filed_at + 5 years (hard-delete blocked before this)

  -- Compliance review
  reviewed_by                 UUID REFERENCES users(id),  -- KI or CO review
  reviewed_at                 TIMESTAMPTZ,
  review_notes                TEXT,

  advice_date                 DATE NOT NULL DEFAULT CURRENT_DATE,

  created_at                  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at                  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  deleted_at                  TIMESTAMPTZ,
  created_by                  UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_roa_client ON records_of_advice(tenant_id, client_id);
CREATE INDEX idx_roa_agent ON records_of_advice(tenant_id, agent_id);
CREATE INDEX idx_roa_policy ON records_of_advice(tenant_id, policy_id);
CREATE INDEX idx_roa_status ON records_of_advice(tenant_id, status);
```

---

### 3.16 replacement_advice_records (RPAR)

```sql
CREATE TABLE replacement_advice_records (
  id                        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id                 UUID NOT NULL REFERENCES tenants(id),
  roa_id                    UUID NOT NULL REFERENCES records_of_advice(id),
  client_id                 UUID NOT NULL REFERENCES clients(id),
  agent_id                  UUID NOT NULL REFERENCES agents(id),

  -- Existing policy details
  existing_policy_id        UUID REFERENCES policies(id),
  existing_insurer          TEXT NOT NULL,
  existing_product          TEXT NOT NULL,
  existing_premium          DECIMAL(15,2),
  existing_benefit          DECIMAL(15,2),
  existing_exclusions       TEXT,
  existing_waiting_periods  TEXT,
  existing_premium_at_lapse DECIMAL(15,2),  -- If proposing lapse before replacement

  -- Proposed replacement
  proposed_insurer          TEXT NOT NULL,
  proposed_product          TEXT NOT NULL,
  proposed_premium          DECIMAL(15,2),
  proposed_benefit          DECIMAL(15,2),
  proposed_exclusions       TEXT,
  proposed_waiting_periods  TEXT,

  -- Replacement justification
  replacement_reason        TEXT NOT NULL,
  client_advantages         TEXT NOT NULL,     -- Why this is in client's best interest
  client_disadvantages      TEXT NOT NULL,     -- Honest disclosure of downsides
  new_waiting_periods_flag  BOOLEAN NOT NULL,
  clawback_exposure_flag    BOOLEAN NOT NULL,
  loss_of_benefits_flag     BOOLEAN NOT NULL,

  -- Client acknowledgement
  client_acknowledged       BOOLEAN NOT NULL DEFAULT false,
  client_acknowledged_at    TIMESTAMPTZ,
  client_signature_method   TEXT,

  -- Output PDF
  rpar_pdf_document_id      UUID,

  retain_until              TIMESTAMPTZ,       -- filed_at + 5 years

  created_at                TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at                TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by                UUID NOT NULL REFERENCES users(id)
);
```

---

### 3.17 claims

```sql
CREATE TABLE claims (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id             UUID NOT NULL REFERENCES tenants(id),
  policy_id             UUID NOT NULL REFERENCES policies(id),
  client_id             UUID NOT NULL REFERENCES clients(id),
  agent_id              UUID REFERENCES agents(id),

  -- FNOL
  claim_reference       TEXT,                         -- Insurer-assigned reference
  claim_type            claim_type NOT NULL,
  fnol_date             DATE NOT NULL,
  incident_date         DATE,
  incident_description  TEXT,

  -- Claimant (may differ from policyholder — e.g. beneficiary on death claim)
  claimant_name         TEXT,
  claimant_id_number    TEXT,
  claimant_relationship TEXT,
  claimant_phone        TEXT,
  claimant_email        TEXT,
  claimant_banking_name TEXT,
  claimant_account_no   TEXT,
  claimant_bank_code    TEXT,

  -- Status
  status                claim_status NOT NULL DEFAULT 'filed',
  status_changed_at     TIMESTAMPTZ,

  -- Insurer handler
  insurer_handler_name  TEXT,
  insurer_handler_phone TEXT,
  insurer_handler_email TEXT,

  -- Outstanding documents checklist (JSONB array of {doc, required, received})
  document_checklist    JSONB NOT NULL DEFAULT '[]',

  -- Assessment
  assessment_started_at TIMESTAMPTZ,
  assessment_notes      TEXT,

  -- Outcome
  outcome               TEXT,                -- 'approved' | 'repudiated' | 'partial'
  outcome_date          DATE,
  approved_amount       DECIMAL(15,2),
  paid_date             DATE,
  repudiation_reason    TEXT,

  -- Ombudsman escalation
  ombud_escalated       BOOLEAN DEFAULT false,
  ombud_type            ombudsman_type,
  ombud_reference       TEXT,
  ombud_lodged_date     DATE,
  ombud_limitation_expires DATE,            -- ombud_lodged_date + 3 years
  ombud_determination   TEXT,
  ombud_determination_date DATE,

  created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  deleted_at            TIMESTAMPTZ,
  created_by            UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_claims_policy ON claims(tenant_id, policy_id);
CREATE INDEX idx_claims_client ON claims(tenant_id, client_id);
CREATE INDEX idx_claims_status ON claims(tenant_id, status);
```

---

### 3.18 commission_structures

```sql
CREATE TABLE commission_structures (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id           UUID NOT NULL REFERENCES tenants(id),
  name                TEXT NOT NULL,
  description         TEXT,

  -- Per product category rates
  rates               JSONB NOT NULL,
  -- Structure:
  -- {
  --   "life":                { "initial_pct": 0.75, "renewal_pct": 0.075, "clawback_months": 24 },
  --   "disability_lump":     { "initial_pct": 0.75, "renewal_pct": 0.075, "clawback_months": 24 },
  --   "short_term_personal": { "monthly_pct": 0.125 },
  --   "medical_aid":         { "broker_fee_per_member": 100.95 }
  -- }

  is_default          BOOLEAN DEFAULT false,
  created_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by          UUID NOT NULL REFERENCES users(id)
);
```

---

### 3.19 commissions

```sql
CREATE TABLE commissions (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id             UUID NOT NULL REFERENCES tenants(id),
  policy_id             UUID NOT NULL REFERENCES policies(id),
  agent_id              UUID NOT NULL REFERENCES agents(id),

  commission_type       commission_type NOT NULL,
  statement_period      TEXT NOT NULL,             -- e.g. '2026-02'
  insurer_name          TEXT NOT NULL,

  -- Amounts
  premium_amount        DECIMAL(15,2),             -- Premium this commission is on
  commission_rate       DECIMAL(5,4),
  gross_commission      DECIMAL(15,2) NOT NULL,

  -- Clawback
  clawback_amount       DECIMAL(15,2),
  clawback_reason       TEXT,
  clawback_triggered_at TIMESTAMPTZ,

  net_commission        DECIMAL(15,2),             -- gross - clawback

  -- Statement
  statement_id          UUID,                      -- FK to commission_statements
  paid_date             DATE,
  reconciled            BOOLEAN DEFAULT false,
  reconciled_at         TIMESTAMPTZ,

  created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by            UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_commissions_agent ON commissions(tenant_id, agent_id);
CREATE INDEX idx_commissions_policy ON commissions(tenant_id, policy_id);
CREATE INDEX idx_commissions_period ON commissions(tenant_id, statement_period);
```

---

### 3.20 commission_statements

```sql
CREATE TABLE commission_statements (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES tenants(id),
  agent_id        UUID NOT NULL REFERENCES agents(id),
  insurer_name    TEXT NOT NULL,
  statement_period TEXT NOT NULL,             -- e.g. '2026-02'
  statement_date  DATE NOT NULL,

  total_new_business    DECIMAL(15,2) DEFAULT 0,
  total_renewal         DECIMAL(15,2) DEFAULT 0,
  total_clawback        DECIMAL(15,2) DEFAULT 0,
  total_binder_fees     DECIMAL(15,2) DEFAULT 0,
  net_payable           DECIMAL(15,2) DEFAULT 0,

  source_file_document_id UUID,
  imported_at           TIMESTAMPTZ,
  imported_by           UUID REFERENCES users(id),

  created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by            UUID NOT NULL REFERENCES users(id)
);
```

---

### 3.21 documents

```sql
CREATE TABLE documents (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id           UUID NOT NULL REFERENCES tenants(id),

  -- Storage
  storage_key         TEXT NOT NULL UNIQUE,     -- R2 object key
  original_filename   TEXT NOT NULL,
  mime_type           TEXT NOT NULL,
  file_size_bytes     INTEGER NOT NULL,
  checksum_sha256     TEXT,

  -- Classification
  category            document_category NOT NULL,

  -- Entity links (nullable — document can link to any entity)
  client_id           UUID REFERENCES clients(id),
  agent_id            UUID REFERENCES agents(id),
  policy_id           UUID REFERENCES policies(id),
  claim_id            UUID REFERENCES claims(id),
  roa_id              UUID REFERENCES records_of_advice(id),

  -- Retention
  expires_at          TIMESTAMPTZ,               -- For POA (3-month), SAPS clearance, etc.
  retain_until        TIMESTAMPTZ,               -- FAIS 5-year retention (hard-delete blocked)
  expiry_alerted      BOOLEAN DEFAULT false,

  -- Virus scan
  av_scanned          BOOLEAN DEFAULT false,
  av_clean            BOOLEAN,
  av_scanned_at       TIMESTAMPTZ,

  description         TEXT,

  created_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  uploaded_by         UUID NOT NULL REFERENCES users(id),
  deleted_at          TIMESTAMPTZ
);

CREATE INDEX idx_documents_tenant ON documents(tenant_id);
CREATE INDEX idx_documents_client ON documents(tenant_id, client_id);
CREATE INDEX idx_documents_agent ON documents(tenant_id, agent_id);
CREATE INDEX idx_documents_category ON documents(tenant_id, category);
CREATE INDEX idx_documents_expiry ON documents(tenant_id, expires_at) WHERE expires_at IS NOT NULL;
```

---

### 3.22 notifications

```sql
CREATE TABLE notifications (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES tenants(id),
  user_id         UUID NOT NULL REFERENCES users(id),

  type            TEXT NOT NULL,   -- 'renewal_due' | 'lapse_risk' | 'cpd_alert' etc.
  title           TEXT NOT NULL,
  body            TEXT NOT NULL,
  data            JSONB,           -- Context data (policy_id, client_id, etc.)

  channel         TEXT NOT NULL,   -- 'in_app' | 'email' | 'sms'
  read            BOOLEAN DEFAULT false,
  read_at         TIMESTAMPTZ,
  sent            BOOLEAN DEFAULT false,
  sent_at         TIMESTAMPTZ,
  error           TEXT,

  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_notifications_user ON notifications(tenant_id, user_id, read);
```

---

### 3.23 tasks

```sql
CREATE TABLE tasks (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id         UUID NOT NULL REFERENCES tenants(id),
  assigned_to       UUID NOT NULL REFERENCES users(id),
  created_by_user   UUID NOT NULL REFERENCES users(id),

  title             TEXT NOT NULL,
  description       TEXT,
  type              TEXT NOT NULL,
  -- 'renewal_review' | 'lapse_prevention' | 'cpd_reminder' | 'roa_outstanding'
  -- 'fica_refresh' | 'client_follow_up' | 'claims_follow_up' | 'general'

  priority          TEXT DEFAULT 'normal',  -- 'low' | 'normal' | 'high' | 'urgent'
  status            TEXT DEFAULT 'todo',    -- 'todo' | 'in_progress' | 'done' | 'cancelled'

  -- Links
  policy_id         UUID REFERENCES policies(id),
  client_id         UUID REFERENCES clients(id),
  lead_id           UUID REFERENCES leads(id),
  claim_id          UUID REFERENCES claims(id),

  due_date          DATE,
  completed_at      TIMESTAMPTZ,
  escalated_to      UUID REFERENCES users(id),
  escalated_at      TIMESTAMPTZ,

  created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_tasks_assignee ON tasks(tenant_id, assigned_to, status);
CREATE INDEX idx_tasks_due ON tasks(tenant_id, due_date) WHERE status NOT IN ('done', 'cancelled');
```

---

### 3.24 complaints

```sql
CREATE TABLE complaints (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id             UUID NOT NULL REFERENCES tenants(id),
  client_id             UUID NOT NULL REFERENCES clients(id),
  agent_id              UUID REFERENCES agents(id),
  policy_id             UUID REFERENCES policies(id),

  complaint_date        DATE NOT NULL,
  nature                TEXT NOT NULL,
  description           TEXT NOT NULL,

  status                complaint_status NOT NULL DEFAULT 'lodged',

  -- Internal resolution
  resolution            TEXT,
  resolved_at           TIMESTAMPTZ,
  resolved_by           UUID REFERENCES users(id),

  -- Ombud escalation
  escalated_to_ombud    BOOLEAN DEFAULT false,
  ombud_type            ombudsman_type,
  ombud_reference       TEXT,
  ombud_lodged_date     DATE,
  ombud_limitation_expires DATE,   -- lodged_date + 3 years (FAIS Ombud)
  ombud_determination   TEXT,
  ombud_determination_date DATE,
  ombud_award_amount    DECIMAL(15,2),

  created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by            UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_complaints_tenant ON complaints(tenant_id, status);
CREATE INDEX idx_complaints_client ON complaints(tenant_id, client_id);
```

---

### 3.25 audit_logs

```sql
CREATE TABLE audit_logs (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id   UUID,
  table_name  TEXT NOT NULL,
  record_id   UUID NOT NULL,
  action      TEXT NOT NULL,      -- 'INSERT' | 'UPDATE' | 'DELETE'
  changed_by  UUID,               -- user_id (NULL for system actions)
  old_data    JSONB,
  new_data    JSONB,
  metadata    JSONB,              -- { ip_address, user_agent, request_id }
  created_at  TIMESTAMPTZ NOT NULL DEFAULT NOW()
  -- IMMUTABLE: No UPDATE or DELETE granted on this table
);

CREATE INDEX idx_audit_tenant ON audit_logs(tenant_id, created_at DESC);
CREATE INDEX idx_audit_record ON audit_logs(table_name, record_id);
```

---

## 4. Entity Relationship Summary

```
tenants
  └── users (M)
  └── agents (M) → extends users
      └── cpd_activities (M)
  └── clients (M) → assigned to agents
      └── dependants (M)
      └── fica_profiles (1)
      └── needs_analyses (M)
      └── leads (1) [origin]
  └── leads (M) → assigned to agents
      └── lead_activities (M)
  └── quotes (M) → client + agent + fna
  └── policies (M) → client + agent + quote
      └── beneficiaries (M)
      └── policy_endorsements (M)
      └── records_of_advice (1)
          └── replacement_advice_records (1) [if replacement]
      └── commissions (M)
      └── claims (M)
          └── [claim documents via documents table]
  └── commission_structures (M) → assigned to agents
  └── commission_statements (M)
  └── documents (M) → polymorphic links
  └── notifications (M) → users
  └── tasks (M) → users
  └── complaints (M) → client + agent + policy
  └── audit_logs (M) → all tables
```

---

## 5. Prisma Schema (abbreviated)

```prisma
// Full schema in apps/api/src/db/schema.prisma

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

model Tenant {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String
  slug                String          @unique
  fspCategory         FspCategory     @default(I) @map("fsp_category")
  authorisedProducts  ProductCategory[] @map("authorised_products")
  // ... (all fields as above)

  users               User[]
  agents              Agent[]
  clients             Client[]
  policies            Policy[]
  // ...

  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  @@map("tenants")
}

model User {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String    @db.Uuid @map("tenant_id")
  email       String
  role        UserRole  @default(agent)
  // ...

  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, email])
  @@map("users")
}
// ... (all other models follow same pattern)
```

---

## 4. CRM Module Schema

### 4.1 crm_pipelines

```sql
CREATE TABLE crm_pipelines (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id     UUID NOT NULL REFERENCES tenants(id),
  name          TEXT NOT NULL,
  description   TEXT,
  pipeline_type TEXT NOT NULL DEFAULT 'deals', -- 'deals' | 'renewals' | 'referrals' | 'custom'
  is_active     BOOLEAN NOT NULL DEFAULT true,
  sort_order    INTEGER NOT NULL DEFAULT 0,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by    UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_crm_pipelines_tenant ON crm_pipelines(tenant_id);
```

### 4.2 crm_stages

```sql
CREATE TABLE crm_stages (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES tenants(id),
  pipeline_id     UUID NOT NULL REFERENCES crm_pipelines(id) ON DELETE CASCADE,
  name            TEXT NOT NULL,
  stage_type      TEXT NOT NULL DEFAULT 'open', -- 'open' | 'won' | 'lost'
  probability     INTEGER NOT NULL DEFAULT 50 CHECK (probability BETWEEN 0 AND 100),
  sort_order      INTEGER NOT NULL DEFAULT 0,
  wip_limit       INTEGER,                       -- NULL = unlimited
  stuck_threshold_days INTEGER DEFAULT 7,
  required_fields TEXT[],                        -- Fields that must be set before moving into this stage
  color           TEXT,                          -- Hex colour for Kanban column header
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_crm_stages_pipeline ON crm_stages(tenant_id, pipeline_id);
```

### 4.3 crm_organizations

```sql
CREATE TABLE crm_organizations (
  id             UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id      UUID NOT NULL REFERENCES tenants(id),
  name           TEXT NOT NULL,
  industry       TEXT,
  website        TEXT,
  phone          TEXT,
  email          TEXT,
  address_line1  TEXT,
  address_line2  TEXT,
  city           TEXT,
  province       TEXT,
  postal_code    TEXT,
  country        TEXT NOT NULL DEFAULT 'ZA',
  notes          TEXT,
  tags           TEXT[],
  custom_fields  JSONB DEFAULT '{}',
  assigned_to    UUID REFERENCES users(id),
  created_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by     UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_crm_organizations_tenant ON crm_organizations(tenant_id);
CREATE INDEX idx_crm_organizations_name ON crm_organizations(tenant_id, name);
```

### 4.4 crm_contacts

```sql
CREATE TABLE crm_contacts (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id         UUID NOT NULL REFERENCES tenants(id),
  client_id         UUID REFERENCES clients(id),               -- NULL if not yet converted to insurance client
  organization_id   UUID REFERENCES crm_organizations(id),
  first_name        TEXT NOT NULL,
  last_name         TEXT NOT NULL,
  email             TEXT,
  phone             TEXT,
  mobile            TEXT,
  job_title         TEXT,
  date_of_birth     DATE,
  id_number         TEXT,
  address_line1     TEXT,
  city              TEXT,
  province          TEXT,
  postal_code       TEXT,
  country           TEXT NOT NULL DEFAULT 'ZA',
  source            TEXT,                                       -- 'referral' | 'cold_call' | 'website' | 'event' | 'other'
  tags              TEXT[],
  custom_fields     JSONB DEFAULT '{}',
  assigned_to       UUID REFERENCES users(id),
  last_activity_at  TIMESTAMPTZ,
  notes             TEXT,
  created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by        UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_crm_contacts_tenant ON crm_contacts(tenant_id);
CREATE INDEX idx_crm_contacts_client ON crm_contacts(tenant_id, client_id);
CREATE INDEX idx_crm_contacts_org ON crm_contacts(tenant_id, organization_id);
```

### 4.5 crm_deals

```sql
CREATE TABLE crm_deals (
  id                   UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id            UUID NOT NULL REFERENCES tenants(id),
  pipeline_id          UUID NOT NULL REFERENCES crm_pipelines(id),
  stage_id             UUID NOT NULL REFERENCES crm_stages(id),
  title                TEXT NOT NULL,
  description          TEXT,
  value                DECIMAL(15,2),
  currency             TEXT NOT NULL DEFAULT 'ZAR',
  probability          INTEGER CHECK (probability BETWEEN 0 AND 100),
  expected_close_date  DATE,
  actual_close_date    DATE,
  deal_status          TEXT NOT NULL DEFAULT 'open', -- 'open' | 'won' | 'lost' | 'on_hold'
  lost_reason          TEXT,
  assigned_to          UUID REFERENCES users(id),
  organization_id      UUID REFERENCES crm_organizations(id),
  -- Insurance links
  client_id            UUID REFERENCES clients(id),
  quote_id             UUID REFERENCES quotes(id),
  policy_id            UUID REFERENCES policies(id),
  -- Metadata
  tags                 TEXT[],
  custom_fields        JSONB DEFAULT '{}',
  last_activity_at     TIMESTAMPTZ,
  stuck_since          TIMESTAMPTZ,
  created_at           TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at           TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by           UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_crm_deals_tenant ON crm_deals(tenant_id);
CREATE INDEX idx_crm_deals_pipeline_stage ON crm_deals(tenant_id, pipeline_id, stage_id);
CREATE INDEX idx_crm_deals_assigned ON crm_deals(tenant_id, assigned_to);
```

### 4.6 crm_deal_contacts

```sql
CREATE TABLE crm_deal_contacts (
  deal_id     UUID NOT NULL REFERENCES crm_deals(id) ON DELETE CASCADE,
  contact_id  UUID NOT NULL REFERENCES crm_contacts(id) ON DELETE CASCADE,
  role        TEXT,  -- 'primary' | 'influencer' | 'decision_maker' | 'other'
  PRIMARY KEY (deal_id, contact_id)
);
```

### 4.7 crm_activities

```sql
CREATE TABLE crm_activities (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id         UUID NOT NULL REFERENCES tenants(id),
  activity_type     TEXT NOT NULL, -- 'call' | 'email' | 'meeting' | 'task' | 'note' | 'sms' | 'whatsapp'
  subject           TEXT NOT NULL,
  description       TEXT,
  outcome           TEXT,          -- For calls/meetings: 'completed' | 'no_answer' | 'left_message'
  -- Polymorphic link (at least one must be set)
  deal_id           UUID REFERENCES crm_deals(id),
  contact_id        UUID REFERENCES crm_contacts(id),
  organization_id   UUID REFERENCES crm_organizations(id),
  -- Scheduling
  scheduled_at      TIMESTAMPTZ,
  completed_at      TIMESTAMPTZ,
  is_done           BOOLEAN NOT NULL DEFAULT false,
  due_date          DATE,
  -- Participants
  assigned_to       UUID REFERENCES users(id),
  created_by_user   UUID NOT NULL REFERENCES users(id),
  -- Email specific
  email_thread_id   TEXT,
  email_direction   TEXT,          -- 'outbound' | 'inbound'
  created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_crm_activities_tenant ON crm_activities(tenant_id);
CREATE INDEX idx_crm_activities_deal ON crm_activities(tenant_id, deal_id);
CREATE INDEX idx_crm_activities_contact ON crm_activities(tenant_id, contact_id);
CREATE INDEX idx_crm_activities_assigned ON crm_activities(tenant_id, assigned_to, is_done);
```

### 4.8 crm_automation_rules

```sql
CREATE TABLE crm_automation_rules (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES tenants(id),
  pipeline_id     UUID REFERENCES crm_pipelines(id), -- NULL = applies to all pipelines
  name            TEXT NOT NULL,
  is_active       BOOLEAN NOT NULL DEFAULT true,
  trigger_event   TEXT NOT NULL, -- 'stage_entered' | 'stage_exited' | 'deal_idle' | 'deal_created' | 'deal_won' | 'deal_lost'
  trigger_config  JSONB NOT NULL DEFAULT '{}', -- e.g. {"stage_id": "uuid", "idle_days": 7}
  action_type     TEXT NOT NULL, -- 'assign_task' | 'send_notification' | 'move_stage' | 'send_email' | 'create_activity'
  action_config   JSONB NOT NULL DEFAULT '{}', -- e.g. {"assign_to": "uuid", "task_title": "Follow up"}
  sort_order      INTEGER NOT NULL DEFAULT 0,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by      UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_crm_automation_tenant ON crm_automation_rules(tenant_id, is_active);
```

---

## 5. Accounting Module Schema

### 5.1 financial_years

```sql
CREATE TABLE financial_years (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES tenants(id),
  name            TEXT NOT NULL,              -- e.g. '2025/2026'
  start_date      DATE NOT NULL,
  end_date        DATE NOT NULL,
  status          TEXT NOT NULL DEFAULT 'open', -- 'open' | 'closed' | 'locked'
  closed_at       TIMESTAMPTZ,
  closed_by       UUID REFERENCES users(id),
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_financial_years_tenant ON financial_years(tenant_id);
```

### 5.2 chart_of_accounts

```sql
CREATE TABLE chart_of_accounts (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES tenants(id),
  account_code    TEXT NOT NULL,
  account_name    TEXT NOT NULL,
  account_type    TEXT NOT NULL, -- 'asset' | 'liability' | 'equity' | 'revenue' | 'expense'
  account_subtype TEXT,          -- 'current_asset' | 'fixed_asset' | 'current_liability' | 'long_term_liability' | 'income' | 'cost_of_sales' | 'operating_expense'
  normal_balance  TEXT NOT NULL, -- 'debit' | 'credit'
  vat_category    TEXT,          -- 'standard_rated' | 'zero_rated' | 'exempt' | 'out_of_scope'
  parent_id       UUID REFERENCES chart_of_accounts(id),
  is_active       BOOLEAN NOT NULL DEFAULT true,
  is_system       BOOLEAN NOT NULL DEFAULT false, -- True for pre-seeded SA template accounts
  description     TEXT,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(tenant_id, account_code)
);

CREATE INDEX idx_coa_tenant ON chart_of_accounts(tenant_id, account_type);
```

### 5.3 bank_accounts

```sql
CREATE TABLE bank_accounts (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id        UUID NOT NULL REFERENCES tenants(id),
  account_name     TEXT NOT NULL,
  bank_name        TEXT NOT NULL,
  account_number   TEXT,
  branch_code      TEXT,           -- SA bank branch codes
  account_type     TEXT,           -- 'cheque' | 'savings' | 'credit_card' | 'petty_cash'
  currency         TEXT NOT NULL DEFAULT 'ZAR',
  opening_balance  DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  coa_account_id   UUID NOT NULL REFERENCES chart_of_accounts(id), -- Linked ledger account
  is_active        BOOLEAN NOT NULL DEFAULT true,
  created_at       TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_bank_accounts_tenant ON bank_accounts(tenant_id);
```

### 5.4 acc_invoices

```sql
CREATE TABLE acc_invoices (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id         UUID NOT NULL REFERENCES tenants(id),
  financial_year_id UUID NOT NULL REFERENCES financial_years(id),
  invoice_type      TEXT NOT NULL DEFAULT 'tax_invoice', -- 'tax_invoice' | 'proforma' | 'credit_note'
  invoice_number    TEXT NOT NULL,
  invoice_date      DATE NOT NULL,
  due_date          DATE,
  -- Bill-to
  client_id         UUID REFERENCES clients(id),          -- If invoicing an existing client
  contact_id        UUID REFERENCES crm_contacts(id),     -- If invoicing a CRM contact
  organization_id   UUID REFERENCES crm_organizations(id),-- If invoicing an organisation
  billing_name      TEXT NOT NULL,
  billing_address   TEXT,
  billing_email     TEXT,
  billing_vat_no    TEXT,
  -- Amounts (computed from line items)
  subtotal          DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  discount_total    DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  vat_total         DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  total             DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  amount_paid       DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  balance_due       DECIMAL(15,2) GENERATED ALWAYS AS (total - amount_paid) STORED,
  -- Status
  status            TEXT NOT NULL DEFAULT 'draft', -- 'draft' | 'sent' | 'partially_paid' | 'paid' | 'overdue' | 'void'
  -- Links
  credit_note_for   UUID REFERENCES acc_invoices(id),    -- If this is a credit note, original invoice
  crm_deal_id       UUID REFERENCES crm_deals(id),
  payment_terms     TEXT,
  notes             TEXT,
  internal_notes    TEXT,
  pdf_document_id   UUID,
  sent_at           TIMESTAMPTZ,
  voided_at         TIMESTAMPTZ,
  voided_by         UUID REFERENCES users(id),
  created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by        UUID NOT NULL REFERENCES users(id),
  UNIQUE(tenant_id, invoice_number)
);

CREATE INDEX idx_acc_invoices_tenant ON acc_invoices(tenant_id, status);
CREATE INDEX idx_acc_invoices_client ON acc_invoices(tenant_id, client_id);
CREATE INDEX idx_acc_invoices_date ON acc_invoices(tenant_id, invoice_date DESC);
```

### 5.5 acc_invoice_line_items

```sql
CREATE TABLE acc_invoice_line_items (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES tenants(id),
  invoice_id      UUID NOT NULL REFERENCES acc_invoices(id) ON DELETE CASCADE,
  sort_order      INTEGER NOT NULL DEFAULT 0,
  description     TEXT NOT NULL,
  quantity        DECIMAL(15,4) NOT NULL DEFAULT 1,
  unit_price      DECIMAL(15,2) NOT NULL,
  discount_pct    DECIMAL(5,2) NOT NULL DEFAULT 0.00,
  line_amount     DECIMAL(15,2) NOT NULL,  -- quantity * unit_price * (1 - discount_pct/100)
  vat_rate        DECIMAL(5,2) NOT NULL DEFAULT 15.00,
  vat_category    TEXT NOT NULL DEFAULT 'standard_rated',
  vat_amount      DECIMAL(15,2) NOT NULL,
  total_amount    DECIMAL(15,2) NOT NULL,  -- line_amount + vat_amount
  coa_account_id  UUID REFERENCES chart_of_accounts(id),
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_acc_line_items_invoice ON acc_invoice_line_items(invoice_id);
```

### 5.6 acc_payments

```sql
CREATE TABLE acc_payments (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id        UUID NOT NULL REFERENCES tenants(id),
  payment_type     TEXT NOT NULL, -- 'received' | 'made'
  payment_date     DATE NOT NULL,
  amount           DECIMAL(15,2) NOT NULL,
  currency         TEXT NOT NULL DEFAULT 'ZAR',
  reference        TEXT,
  description      TEXT,
  bank_account_id  UUID NOT NULL REFERENCES bank_accounts(id),
  -- Party
  client_id        UUID REFERENCES clients(id),
  contact_id       UUID REFERENCES crm_contacts(id),
  organization_id  UUID REFERENCES crm_organizations(id),
  -- Ledger
  coa_account_id   UUID REFERENCES chart_of_accounts(id), -- Expense account for 'made', AR for 'received'
  -- Status
  status           TEXT NOT NULL DEFAULT 'pending', -- 'pending' | 'cleared' | 'reconciled' | 'voided'
  created_at       TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by       UUID NOT NULL REFERENCES users(id)
);

CREATE INDEX idx_acc_payments_tenant ON acc_payments(tenant_id, payment_date DESC);
CREATE INDEX idx_acc_payments_bank ON acc_payments(tenant_id, bank_account_id);
```

### 5.7 acc_payment_allocations

```sql
CREATE TABLE acc_payment_allocations (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id    UUID NOT NULL REFERENCES tenants(id),
  payment_id   UUID NOT NULL REFERENCES acc_payments(id) ON DELETE CASCADE,
  invoice_id   UUID NOT NULL REFERENCES acc_invoices(id),
  amount       DECIMAL(15,2) NOT NULL,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_acc_alloc_payment ON acc_payment_allocations(payment_id);
CREATE INDEX idx_acc_alloc_invoice ON acc_payment_allocations(invoice_id);
```

### 5.8 acc_expense_claims

```sql
CREATE TABLE acc_expense_claims (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES tenants(id),
  submitted_by    UUID NOT NULL REFERENCES users(id),
  description     TEXT NOT NULL,
  claim_date      DATE NOT NULL,
  total_amount    DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  status          TEXT NOT NULL DEFAULT 'draft', -- 'draft' | 'submitted' | 'approved' | 'rejected' | 'paid'
  approved_by     UUID REFERENCES users(id),
  approved_at     TIMESTAMPTZ,
  rejection_reason TEXT,
  notes           TEXT,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE acc_expense_line_items (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id        UUID NOT NULL REFERENCES tenants(id),
  expense_claim_id UUID NOT NULL REFERENCES acc_expense_claims(id) ON DELETE CASCADE,
  description      TEXT NOT NULL,
  amount           DECIMAL(15,2) NOT NULL,
  vat_amount       DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  vat_category     TEXT NOT NULL DEFAULT 'standard_rated',
  coa_account_id   UUID NOT NULL REFERENCES chart_of_accounts(id),
  receipt_document_id UUID,
  expense_date     DATE NOT NULL,
  created_at       TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_expense_claims_tenant ON acc_expense_claims(tenant_id, submitted_by);
```

### 5.9 bank_transactions

```sql
CREATE TABLE bank_transactions (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id           UUID NOT NULL REFERENCES tenants(id),
  bank_account_id     UUID NOT NULL REFERENCES bank_accounts(id),
  transaction_date    DATE NOT NULL,
  description         TEXT NOT NULL,
  reference           TEXT,
  amount              DECIMAL(15,2) NOT NULL, -- Positive = debit (money in); Negative = credit (money out)
  running_balance     DECIMAL(15,2),
  transaction_type    TEXT, -- 'debit' | 'credit'
  source              TEXT NOT NULL DEFAULT 'manual', -- 'manual' | 'csv_import' | 'system'
  reconciled          BOOLEAN NOT NULL DEFAULT false,
  reconciliation_id   UUID,
  payment_id          UUID REFERENCES acc_payments(id),  -- Auto-matched payment
  matched_at          TIMESTAMPTZ,
  created_at          TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_bank_txn_account ON bank_transactions(tenant_id, bank_account_id, transaction_date DESC);
CREATE INDEX idx_bank_txn_unreconciled ON bank_transactions(tenant_id, bank_account_id) WHERE reconciled = false;
```

### 5.10 bank_reconciliations

```sql
CREATE TABLE bank_reconciliations (
  id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id               UUID NOT NULL REFERENCES tenants(id),
  bank_account_id         UUID NOT NULL REFERENCES bank_accounts(id),
  financial_year_id       UUID NOT NULL REFERENCES financial_years(id),
  period_start            DATE NOT NULL,
  period_end              DATE NOT NULL,
  statement_balance       DECIMAL(15,2) NOT NULL,
  ledger_balance          DECIMAL(15,2) NOT NULL,
  difference              DECIMAL(15,2) GENERATED ALWAYS AS (statement_balance - ledger_balance) STORED,
  status                  TEXT NOT NULL DEFAULT 'in_progress', -- 'in_progress' | 'reconciled' | 'locked'
  reconciled_at           TIMESTAMPTZ,
  reconciled_by           UUID REFERENCES users(id),
  created_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at              TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_bank_recon_tenant ON bank_reconciliations(tenant_id, bank_account_id);
```

### 5.11 journal_entries

```sql
CREATE TABLE journal_entries (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id        UUID NOT NULL REFERENCES tenants(id),
  financial_year_id UUID NOT NULL REFERENCES financial_years(id),
  entry_number     TEXT NOT NULL,
  entry_date       DATE NOT NULL,
  description      TEXT NOT NULL,
  reference        TEXT,
  entry_type       TEXT NOT NULL DEFAULT 'manual', -- 'manual' | 'system_invoice' | 'system_payment' | 'system_clawback' | 'system_commission' | 'year_end'
  status           TEXT NOT NULL DEFAULT 'draft', -- 'draft' | 'posted' | 'reversed'
  reversed_by      UUID REFERENCES journal_entries(id),
  -- Source reference
  source_type      TEXT,   -- 'invoice' | 'payment' | 'commission' | 'expense_claim'
  source_id        UUID,
  total_debit      DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  total_credit     DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  posted_at        TIMESTAMPTZ,
  posted_by        UUID REFERENCES users(id),
  created_at       TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by       UUID NOT NULL REFERENCES users(id),
  UNIQUE(tenant_id, entry_number)
);

CREATE INDEX idx_journal_entries_tenant ON journal_entries(tenant_id, status, entry_date DESC);
```

### 5.12 journal_entry_lines

```sql
CREATE TABLE journal_entry_lines (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id         UUID NOT NULL REFERENCES tenants(id),
  journal_entry_id  UUID NOT NULL REFERENCES journal_entries(id) ON DELETE CASCADE,
  sort_order        INTEGER NOT NULL DEFAULT 0,
  coa_account_id    UUID NOT NULL REFERENCES chart_of_accounts(id),
  description       TEXT,
  debit_amount      DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  credit_amount     DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  -- Validation: debit_amount XOR credit_amount should be > 0
  CONSTRAINT debit_or_credit CHECK (
    (debit_amount > 0 AND credit_amount = 0) OR
    (credit_amount > 0 AND debit_amount = 0)
  )
);

CREATE INDEX idx_journal_lines_entry ON journal_entry_lines(journal_entry_id);
CREATE INDEX idx_journal_lines_account ON journal_entry_lines(tenant_id, coa_account_id);
```

---

## 6. Row-Level Security (RLS) Policies for New Tables

The same RLS pattern used throughout the schema applies to all CRM and Accounting tables:

```sql
-- Apply to each new table (example for crm_deals):
ALTER TABLE crm_deals ENABLE ROW LEVEL SECURITY;

CREATE POLICY crm_deals_tenant_isolation ON crm_deals
  USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

-- Repeat for: crm_pipelines, crm_stages, crm_organizations, crm_contacts,
--             crm_deal_contacts, crm_activities, crm_automation_rules,
--             financial_years, chart_of_accounts, bank_accounts, acc_invoices,
--             acc_invoice_line_items, acc_payments, acc_payment_allocations,
--             acc_expense_claims, acc_expense_line_items, bank_transactions,
--             bank_reconciliations, journal_entries, journal_entry_lines
```
